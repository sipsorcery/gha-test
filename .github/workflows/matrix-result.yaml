name: Matrix Record Results Test

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  repository_dispatch:
    types: [matrix-test-command]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/passing-information-between-jobs
jobs:
  # Job Description: Performs the Data Channel Test between each combination of the client and server for each library.
  interop-tests:
    runs-on: ubuntu-latest

    # Map a step output to a job output
    outputs:
      result_a_c: ${{ steps.maintask.outputs.result1 }}
      result_a_d: ${{ steps.maintask.outputs.result2 }}
      result_b_c: ${{ steps.maintask.outputs.result3 }}
      result_b_d: ${{ steps.maintask.outputs.result4 }}

    strategy:
      matrix:
        server: ["a", "b"]
        client: ["c", "d"]

    steps:
      - name: Run main task
        id: maintask
        run: |
          # Store output
          echo "result_${{ matrix.server }}_${{ matrix.client }}=${{ matrix.client }}" >> "$GITHUB_OUTPUT"

  collate:
    runs-on: ubuntu-latest
    needs: [interop-tests]
    
    steps:
      - name: Collate
        run: |
          echo "Collating..."
          echo "The output from interop-test is: ${{ toJSON(needs.interop-tests.outputs) }}"
